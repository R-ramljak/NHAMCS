---
title: "Survey Statistics | Project NHAMCS"
author: "Rianne, Piet, Zhenwei, Marco"
date: "Dec 16, 2019"
output:
  html_document:
    code_folding: hide
    theme: cosmo
    toc: yes
    toc_float: yes
  word_document:
    toc: yes
---


```{r}
library(tidyverse)
library(survey)
library(sampling)
library(kableExtra)
```


```{r}
data <- read_csv("nhamcsed2010-short.csv") %>%
  rownames_to_column("id")
```


### 1. The variable CPSUM represents geographic primary sampling units (clusters), a variable CSTRATM represents relevant strata (e.g., emergency service areas within emergency departments or outpatient departments), variable PATWT represents an additional patient visit weight variable.

#### a. Explain this multistage sampling design. Do the PATWT weights sum up to N, and what does this mean?

```{r}
sum(data$PATWT)
```

Yes, the weights add up to N.

#### b. Define the svydesign() function with clusters, strata, and (additional) weights.

```{r}
data.design <- svydesign(id = ~CPSUM, strata = ~CSTRATM, weight = ~PATWT, data = data, nest = TRUE)
```

#### c. When considering gender differences in emergency visits, is it more likely for men than women to visit an emergency department, explain?

```{r}
# Population estimates --> 
svytotal(~interaction(SEX), data.design)
```


#### d. Is there a mean difference between males and females in weights (PATWT), what do you conclude from this?

### 2. Estimate the average waiting time in the population under the specified svydesign. 

#### a. What do you conclude?

```{r}
(result.2a <- svymean(~WAITTIME, data.design, na.rm = T))
```
The average waiting time is almost 45 min. 

#### b. Exclude the cluster and strata information, (redefine the svydesign), how this change your result in 2a, explain?

```{r}
# Defining the design object but without any design specifications
data.design.exc <- svydesign(id = ~id, weight = ~PATWT, data = data, nest = TRUE) # nest can be basically ignored

(result.2b <- svymean(~WAITTIME, data.design.exc, na.rm = T))
```

The estimates are the same (about 45 min) but the the SE are too small for the option without any design specifications. Explanation needed.

#### c. Draw an SRS sample to estimate the average waiting time. Estimate the average waiting time, and compare the result(s) with the result(s) of 2a and 2b.

```{r}
# With the srswr function we can draw a srs, which gives us a vector of the sample cases
sample.2c.vec <- srswr(n = 1000, N = length(data$id))
sample.2c <- getdata(data, sample.2c.vec)

# We can then create another svydesign object and estimate the average waiting time
sample.2c.des <- svydesign(id = ~id, data = sample.2c, nest = TRUE)
a <- result.2c <- svymean(~WAITTIME, sample.2c.des, na.rm = T)

# Comparing the results 
name.results <- c("2a Estimate (design specified)", "2b Estimate (design not specified)", "2c Estimate (new srs)")

# Still need to add the SEs to the table for better comparison
results.2 <- tibble(name.results, estimates = c(result.2a, result.2b, result.2c),
                    SE = c(map_dbl(list(result.2a, result.2b, result.2c), ~attr(., which = "var"))))

```


#### d. Draw a stratified sample to investigate the variability in waiting times over regions (Northeast, Midwest, South, West). Is there variability in waiting times over regions?

```{r}
# In order for drawing a stratified sample we need to arrange the original dataset in ascending strata order (Region)
data.strata.prep <- data %>%
  arrange(REGION)

# With the strata function we can draw a stratified srs. The size vector specifies the strata sample sizes 
# Question: Should we change the sizes to PPS?
sample.2d.vec <- strata(data = data.strata.prep, stratanames = "REGION", size = c(250, 250, 250, 250), method = "srswr")
sample.2d <- getdata(data.strata.prep, sample.2c.vec)

sample.2d.des <- svydesign(id = ~id, data = sample.2d, nest = TRUE) # is nest necessary?
svymean(~WAITTIME, sample.2d.des, na.rm = T)
```


### 3. Explain that a ratio estimator can be used to improve the estimation of the average waiting time. 

#### b. Describe potential variables for ratio estimation, and choose one to compute a ratio estimate of the average weighting time. 

#### c. Give a 95% confidence interval for your preferable estimate of the average waiting time, and explain the result.


### 4. Investigate differences in waiting times among ethnic groups by fitting a linear regression model. Compare estimated results of a stratified sampling design and an unequal probability sampling design.


### 5. Assume unequal probability sampling, can you identify the important predictor variables of waiting times of patients visiting an ED? What can be concluded?